#!/bin/bash

# StreamTalk WebRTC Implementation Test Guide
# ==========================================

echo "ðŸŽ™ï¸ StreamTalk WebRTC Testing Guide"
echo "==================================="
echo ""

echo "ðŸ“‹ Manual Testing Checklist:"
echo ""

echo "1. HOST SETUP:"
echo "   âœ… Go to /streamer/dashboard"
echo "   âœ… Create a session (click 'Start Session')"
echo "   âœ… Verify host participant is created in Firestore"
echo "   âœ… Check browser console for '[StreamerDashboard] Host session initialized successfully'"
echo "   âœ… Verify microphone permission is granted"
echo "   âœ… Copy the invite link"
echo ""

echo "2. VIEWER SETUP:"
echo "   âœ… Open invite link in new browser/incognito window"
echo "   âœ… Enter name and click 'Join Queue to Speak'"
echo "   âœ… Check console for '[ViewerInterface] Participant created with ID: xxx'"
echo "   âœ… Verify participant appears in Firestore under /rooms/{roomId}/participants/"
echo "   âœ… Check that viewer can hear host audio"
echo ""

echo "3. WEBRTC CONNECTION:"
echo "   âœ… Host should see new participant in queue"
echo "   âœ… Check console for '[WebRTC] Creating peer connection to xxx, initiator: true'"
echo "   âœ… Viewer should show 'Host Audio: Connected'"
echo "   âœ… Check Firestore for signals at /rooms/{roomId}/participants/{participantId}/signals/"
echo ""

echo "4. SPEAKING FLOW:"
echo "   âœ… Host clicks 'Select' on a viewer"
echo "   âœ… Viewer should be prompted for microphone permission"
echo "   âœ… Viewer interface should show 'You're Speaking!'"
echo "   âœ… Host should hear viewer audio"
echo "   âœ… Check console for peer 'stream' and 'connect' events"
echo ""

echo "5. FIRESTORE STRUCTURE CHECK:"
echo "   Expected structure:"
echo "   ðŸ“ /rooms/{roomId}/"
echo "   â”œâ”€â”€ room document (hostId, hostParticipantId, title, etc.)"
echo "   â””â”€â”€ ðŸ“ participants/"
echo "       â”œâ”€â”€ {hostParticipantId}/ (isHost: true)"
echo "       â”‚   â””â”€â”€ ðŸ“ signals/ (WebRTC signaling docs)"
echo "       â””â”€â”€ {viewerParticipantId}/ (isHost: false)"
echo "           â””â”€â”€ ðŸ“ signals/ (WebRTC signaling docs)"
echo ""

echo "6. CONSOLE LOG VERIFICATION:"
echo "   Expected logs sequence:"
echo "   ðŸ”§ [Firestore] Creating host participant for room xxx"
echo "   ðŸ”§ [WebRTC] Initializing audio..."
echo "   ðŸ”§ [Firestore] Adding participant to room xxx"
echo "   ðŸ”§ [WebRTC] Creating peer connection to xxx, initiator: true"
echo "   ðŸ”§ [WebRTC] Sending offer signal to xxx"
echo "   ðŸ”§ [Firestore] Signal added with ID: xxx"
echo "   ðŸ”§ [WebRTC] Processing incoming answer signal"
echo "   ðŸ”§ [WebRTC] Received stream from xxx"
echo ""

echo "ðŸš¨ TROUBLESHOOTING:"
echo ""
echo "âŒ No audio connection:"
echo "   - Check browser console for WebRTC errors"
echo "   - Verify HTTPS (required for getUserMedia)"
echo "   - Check if signals are being created/deleted in Firestore"
echo "   - Try refreshing both windows"
echo ""

echo "âŒ Signals not exchanging:"
echo "   - Verify participantId consistency between components"
echo "   - Check Firestore rules allow read/write to signals subcollection"
echo "   - Look for 'initiator' mismatch in peer creation"
echo ""

echo "âŒ Host participant missing:"
echo "   - Check if createHostParticipant is called on session start"
echo "   - Verify hostParticipantId is saved to room document"
echo ""

echo "ðŸ” DEBUG COMMANDS:"
echo ""
echo "Check Firestore directly:"
echo "firebase firestore:shell"
echo "db.collection('rooms').get().then(snap => snap.docs.map(doc => ({id: doc.id, ...doc.data()})))"
echo ""

echo "Chrome WebRTC internals:"
echo "chrome://webrtc-internals/"
echo ""

echo "âœ… SUCCESS CRITERIA:"
echo "1. Host can hear multiple viewers when they speak"
echo "2. Viewers can hear host audio continuously"
echo "3. Audio quality is clear without echo/feedback"
echo "4. Firestore signals are created and cleaned up properly"
echo "5. Console shows successful peer connections and streams"
echo ""

echo "ðŸŽ¯ Test with 2-3 viewers simultaneously for full verification!"